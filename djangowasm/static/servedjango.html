<html lang="en">
<head>
    <title>Django Server</title>
    <script>
        async function setup_messaging(buffer, sync, receiving_port) {
            self.receiving_port = receiving_port
            self.buffer = buffer
            self.sync = sync
            self.receiving_port.onmessage = async e => {
                const websocket = await self.socket_promise
                console.log(`Sending ${e.data} over websocket`)
                websocket.send(e.data)
            }
            function connect() {
                return new Promise((resolve, reject) => {
                    console.log("Connecting to WebSocket")
                    let socket = new WebSocket('ws://localhost:6432')
                    socket.binaryType = "arraybuffer"
                    console.log("Websocket connected")
                    socket.onopen = () => { resolve(socket) }
                    socket.onmessage = async e => {
                        const data = new Uint8Array(e.data)
                        console.log(`Preparing to pass along message ${data}`)
                        await Atomics.waitAsync(self.sync, 0, 1)
                        console.log(`Message ready to pass along: length ${data.length}`)
                        self.sync[1] = data.length
                        // const encoded = new TextEncoder().encode(e.data)
                        for (let ind = 0; ind < data.length; ind += 1) {
                            self.buffer[ind] = data[ind]
                        }
                        console.log(`buffer[0] is ${buffer[0]}`)
                        Atomics.store(self.sync, 0, 1)
                        Atomics.notify(self.sync, 0, 1)
                        console.log(`Messaged received and ready to be read: self.sync[0] = ${self.sync[0]}`)
                    }
                })
            }
            self.socket_promise = connect()
        }

        async function main() {
            const worker = new Worker('/static/djangoworker.js')
            const sync = new Int32Array(new SharedArrayBuffer(8))
            const buffer = new Uint8Array(new SharedArrayBuffer(16384))
            const channel = new MessageChannel()
            await setup_messaging(buffer, sync, channel.port1)
            worker.postMessage(
                {
                    sending_port: channel.port2,
                    sync: sync,
                    buffer: buffer,
                    requirements: [
                        // '/static/wasmsockets-0.1.4-py3-none-any.whl',
                        // 'django',
                        'scramp',
                        'python-dateutil',
                        // '/static/pgwasm-0.2.1-py3-none-any.whl',
                        // '/static/django_postgresql_ws-0.1.0-py3-none-any.whl',
                    ],
                    package_url: '/static/djangosample.zip',
                    settings_package: 'djangosample.settings',
                },
                [channel.port2],
            )
        }
        main().then()
    </script>
</head>
<body>
<h1>Check console</h1>
</body>