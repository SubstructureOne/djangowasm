<html lang="en">
<head>
    <title>Django Server</title>
    <script>
        async function setup_messaging(buffer, sync, receiving_port) {
            self.receiving_port = receiving_port
            self.buffer = buffer
            self.sync = sync
            self.receiving_port.onmessage = async e => {
                const websocket = await self.socket_promise
                console.log(`Sending ${e.data} over websocket`)
                websocket.send(e.data)
            }
            function connect() {
                return new Promise((resolve, reject) => {
                    let socket = new WebSocket('ws://localhost:8765')
                    socket.onopen = () => { resolve(socket) }
                    socket.onmessage = async e => {
                        await Atomics.waitAsync(self.sync, 0, 1)
                        self.sync[1] = e.data.length
                        const encoded = new TextEncoder().encode(e.data)
                        for (let ind = 0; ind < e.data.length; ind += 1) {
                            self.buffer[ind] = encoded[ind]
                        }
                        Atomics.store(self.sync, 0, 1)
                        Atomics.notify(self.sync, 0, 1)
                    }
                })
            }
            self.socket_promise = connect()
        }

        async function main() {
            const worker = new Worker('/static/djangoworker.js')
            const sync = new Int32Array(new SharedArrayBuffer(8))
            const buffer = new Uint8Array(new SharedArrayBuffer(1024))
            const channel = new MessageChannel()
            await setup_messaging(buffer, sync, channel.port1)
            worker.postMessage(
                {
                    sending_port: channel.port2,
                    sync: sync,
                    buffer: buffer,
                    requirements: [],
                    package_url: '',
                    settings_package: '',
                },
                [channel.port2],
            )
        }
        main().then()
    </script>
</head>
<body>
<h1>Check console</h1>
</body>