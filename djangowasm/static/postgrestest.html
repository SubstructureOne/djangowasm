<html lang="en">
<head>
    <title>Loading...</title>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.21.3/full/pyodide.js"></script>
    <script>
        async function main() {
            let pyodide = await loadPyodide()
            await pyodide.loadPackage('micropip')
            // const micropip = pyodide.pyimport('micropip')
            // await micropip.install('wasmsockets==0.1.1')
            await pyodide.loadPackage("https://files.pythonhosted.org/packages/e1/54/4ee8eca2097c0e1257f833197f787eeb29519f0fcd1423487d3e46dc82e3/wasmsockets-0.1.2-py3-none-any.whl")
            await pyodide.runPythonAsync(`
                import wasmsockets.client
                import js
                import pyodide.ffi

                startupMessage = b'\\x00\\x00\\x00T\\x00\\x03\\x00\\x00user\\x00postgres\\x00database\\x00postgres\\x00application_name\\x00psql\\x00client_encoding\\x00UTF8\\x00\\x00'
                # socket = connect('ws://localhost:8765')
                socket = wasmsockets.client.connect('ws://localhost:6432')
                await socket.send(pyodide.ffi.to_js(startupMessage))
                js.console.log("Waiting for message received")
                result = await socket.recv()
                js.console.log(f'Result: {result}')
                js.console.log(f'Type of converted bytes: {type(pyodide.ffi.to_js(b"ABC"))}')
            `)
        }
        main()
    </script>
</head>

<body>
<h1>Check Console</h1>
</body>
</html>
